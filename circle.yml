machine:
  services:
    - docker
  environment:
    IMAGE: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
    TAG: $CIRCLE_BRANCH-$CIRCLE_SHA1

dependencies:
  override:
    - |
      cat > ~/.dockercfg << EOF
      {
        "https://index.docker.io/v1/": {
          "auth": "$DOCKER_AUTH",
          "email": "$DOCKER_EMAIL"
        }
      }
      EOF
    - docker pull $IMAGE:dev
    - docker build -t $IMAGE:$TAG -f deployment/Dockerfile .

test:
  override:
    - docker run -p 9200:8010 -d $IMAGE:$TAG; sleep 10
    - curl --retry 10 --retry-delay 5 -v http://localhost:9200

deployment:
  staging:
    branch: [dev]
    commands:
      - docker tag -f $IMAGE:$TAG $IMAGE:dev
      - docker push $IMAGE:dev
      - bash deployment/deploy.sh dev
  release:
    branch: [master]
    commands:
      - docker tag -f $IMAGE:$TAG $IMAGE:latest
      - docker push $IMAGE:$TAG
      - docker push $IMAGE:latest
      - bash deployment/deploy.sh prod
